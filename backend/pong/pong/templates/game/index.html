<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pong Multiplayer</title>
	<style>
		body {
			margin: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
			background-color: #000;
			font-family: Arial, sans-serif;
		}

		canvas {
			border: 1px solid #fff;
			background-color: #222;
		}

		#status {
			color: white;
			position: absolute;
			top: 10px;
			text-align: center;
			width: 100%;
			font-size: 18px;
		}
	</style>
</head>

<body>
	<div id="status">Connecting...</div>
	<canvas id="pongCanvas" width="800" height="400"></canvas>

	<script>
		const canvas = document.getElementById('pongCanvas');
		const ctx = canvas.getContext('2d');
		const status = document.getElementById('status');

		let gameSocket; // Use 'let' instead of 'const'
		let reconnectInterval;

		const createWebSocket = () => {
			const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
			const gameSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/game/`);

			gameSocket.onopen = () => {
				status.textContent = 'Connected!';
			};

			gameSocket.onmessage = (e) => {
				const data = JSON.parse(e.data);
				// Check if game_state exists and has the necessary properties
				if (data && data.game_state) {
					gameState = data.game_state;  // Update the game state
					console.log('Updated game state:', gameState); // Log the updated game state
					renderGame();
				} else {
					console.error('Invalid game state received:', data);
				}
			};

			gameSocket.onclose = () => {
				status.textContent = 'Disconnected. Trying to reconnect...';
				reconnectWebSocket();
			};

			gameSocket.onerror = (err) => {
				console.error('WebSocket error:', err);
				status.textContent = 'Error: See console for details.';
			};

			return gameSocket;
		};

		const reconnectWebSocket = () => {
			if (reconnectInterval) clearInterval(reconnectInterval);

			reconnectInterval = setInterval(() => {
				console.log('Attempting to reconnect...');
				gameSocket = createWebSocket(); // Now it's allowed to reassign
			}, 2000);
		};

		let gameState = {
			ball: { x: 400, y: 200 },
			paddle1: { x: 30, y: 150 },
			paddle2: { x: 750, y: 150 },
			score1: 0,
			score2: 0
		};

		const drawRect = (x, y, w, h, color) => {
			ctx.fillStyle = color;
			ctx.fillRect(x, y, w, h);
		};

		const drawCircle = (x, y, radius, color) => {
			ctx.fillStyle = color;
			ctx.beginPath();
			ctx.arc(x, y, radius, 0, Math.PI * 2);
			ctx.closePath();
			ctx.fill();
		};

		const drawText = (text, x, y, color) => {
			ctx.fillStyle = color;
			ctx.font = "24px Arial";
			ctx.fillText(text, x, y);
		};

		const renderGame = () => {
			console.log('Rendering game with state:', gameState);  // Log before rendering

			if (!gameState || !gameState.ball || !gameState.paddle1 || !gameState.paddle2) {
				console.error('Missing game state properties');
				return;  // Prevent rendering if essential properties are missing
			}

			ctx.clearRect(0, 0, canvas.width, canvas.height);

			drawRect(0, 0, canvas.width, canvas.height, '#222');
			drawRect(gameState.paddle1.x, gameState.paddle1.y, 10, 100, 'white');
			drawRect(gameState.paddle2.x, gameState.paddle2.y, 10, 100, 'white');
			drawCircle(gameState.ball.x, gameState.ball.y, 10, 'white');

			drawText(`Player 1: ${gameState.score1}`, 20, 30, 'white');
			drawText(`Player 2: ${gameState.score2}`, canvas.width - 150, 30, 'white');
		};

		// Keydown event for paddle movement (Player 1)
		document.addEventListener('keydown', (event) => {
			if (event.key === 'ArrowUp') {
				updatePaddle(gameState.paddle1.y - 10, 'player1');
			}
			if (event.key === 'ArrowDown') {
				updatePaddle(gameState.paddle1.y + 10, 'player1');
			}
		});

		const updatePaddle = (newY, player) => {
			// Send the paddle movement to the server
			const message = {
				type: 'paddle_move',
				player: player,
				y: newY
			};
			gameSocket.send(JSON.stringify(message));
		};

		// Initialize WebSocket connection
		gameSocket = createWebSocket();
		renderGame();

	</script>
</body>

</html>