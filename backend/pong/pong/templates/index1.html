<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pong Game</title>
	<style>
		/* Container for the game */
		#game-container {
			position: relative;
			width: 600px;
			height: 400px;
			background-color: black;
			overflow: hidden;
			margin: 0 auto;
		}

		/* Ball styling */
		#ball {
			position: absolute;
			width: 12px;
			height: 12px;
			background-color: red;
			border-radius: 50%;
		}

		/* Paddle styling */
		#leftPaddle,
		#rightPaddle {
			position: absolute;
			width: 6px;
			height: 60px;
			background-color: blue;
		}

		#leftPaddle {
			left: 0;
		}

		#rightPaddle {
			right: 0;
		}

		/* Scoreboard styles */
		#scoreboard {
			position: absolute;
			top: 10px;
			width: 100%;
			display: flex;
			justify-content: space-between;
			color: white;
			font-size: 18px;
			padding: 0 20px;
		}

		.controls {
			display: flex;
			justify-content: space-around;
			margin-top: 20px;
		}

		.controls button {
			padding: 10px;
			font-size: 16px;
			cursor: pointer;
		}

		#game-status {
			text-align: center;
			margin-top: 20px;
			font-size: 18px;
		}
	</style>
</head>

<body>
	<h1>Pong Game</h1>
	<div class="controls">
		<button onclick="searchRoom()">Search Game Room</button>
		<button onclick="playAgainstAI()">Play Against AI</button>
	</div>

	<div id="game-container">
		<div id="ball"></div>
		<div id="leftPaddle"></div>
		<div id="rightPaddle"></div>
		<div id="scoreboard">
			<div id="leftScore">0</div>
			<div id="rightScore">0</div>
		</div>
	</div>

	<div id="game-status"></div>

	<script>
		let roomName = null;
		let player1 = 'Player1';
		let player2 = 'AI';
		let player2_is_ai = false;
		let paddleDirection = { up: false, down: false }; // Direction for left paddle

		// Function to create a new game room
		function createRoom() {
			fetch('/pong/create-room/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ player2_is_ai: player2_is_ai })
			})
				.then(response => response.json())
				.then(data => {
					if (data.room_name) {
						roomName = data.room_name
						document.getElementById('game-status').innerText = `Room ${data.room_name} is ready!`;
						startGameLoop();  // Start the game loop
					} else {
						document.getElementById('game-status').innerText = "Error: Could not create or find room.";
					}
				})
				.catch(error => {
					console.error('Error:', error);
					document.getElementById('game-status').innerText = "An error occurred while creating or searching the room.";
				});
		}

		// Function to search for an existing game room
		function searchRoom() {
			fetch(`/pong/search-room/`)
				.then(response => response.json())
				.then(data => {
					if (data.room_name) {
						roomName = data.room_name
						document.getElementById('game-status').innerText = `Joined room ${data.room_name}!`;
						startGameLoop();
					} else {
						player2_is_ai = false;
						createRoom();
						startGameLoop();
						alert("Waiting for opponent!");
					}
				});
		}

		function playAgainstAI() {
			player2_is_ai = true;
			createRoom();
		}

		function startGameLoop() {
			setInterval(() => {
				fetchGameState();
			}, 100);
		}

		async function fetchGameState() {
			try {
				const response = await fetch(`/pong/game_state/${roomName}/`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						room_name: roomName,
						paddle_direction: paddleDirection // Send the paddle movement data
					})
				});

				if (response.ok) {
					const data = await response.json();
					console.log(data);
					updateGameState(data);
				} else {
					const errorText = await response.text();
					console.log('Error fetching game state:', errorText);
				}
			} catch (error) {
				console.error('Error fetching game state:', error);
			}
		}

		function updateGameState(data) {
			const gameContainer = document.getElementById('game-container');
			const gameContainerWidth = gameContainer.offsetWidth;
			const gameContainerHeight = gameContainer.offsetHeight;

			const ball = document.getElementById('ball');
			ball.style.top = `${data.ball_y * gameContainerHeight}px`;
			ball.style.left = `${data.ball_x * gameContainerWidth}px`;

			const leftPaddle = document.getElementById('leftPaddle');
			const rightPaddle = document.getElementById('rightPaddle');
			leftPaddle.style.top = `${data.left_paddle_y * gameContainerHeight}px`;
			rightPaddle.style.top = `${data.right_paddle_y * gameContainerHeight}px`;

			document.getElementById('leftScore').innerText = data.left_score;
			document.getElementById('rightScore').innerText = data.right_score;
		}

		// Listen for keydown events to control the paddle
		document.addEventListener('keydown', (event) => {
			if (event.key === "ArrowUp") {
				paddleDirection.up = true;
			} else if (event.key === "ArrowDown") {
				paddleDirection.down = true;
			}
			else if (event.key === "p" || event.key === "P") {
				isPaused = !isPaused;  // Toggle pause state
				sendPauseState(isPaused);  // Send the paused state to the server
			}
		});

		document.addEventListener('keyup', (event) => {
			if (event.key === "ArrowUp") {
				paddleDirection.up = false;
			} else if (event.key === "ArrowDown") {
				paddleDirection.down = false;
			}
		});
	</script>
</body>

</html>